<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>参数设置</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            margin: 0;
            background-color: #6fbbf9f0;
        }
        .container {
            overflow: auto;
            width: 80%;
            border: 1px solid #ddd;
            padding: 30px;
            border-radius: 10px;
            background-color: #ffffff;
        }
        .center-table-header {
            text-align: center; /* 文本居中 */
        }
        h2 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 2px solid #ddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #ffffff;
        }
        .form-footer {
            text-align: center;
        }
        input[type="submit"] {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 5px;
        }
        input[type="submit"]:hover {
            background-color: #45a049;
        }

        /* style for print */
        @media print {
            /* Hide elements not needed or not suitable for print */
            .hide-on-print, button, header, footer, nav {
                display: none !important;
            }
    
            /* Ensure the content area is wide enough */
            .container, .content {
                width: 100%;
                margin: 0;
                padding: 0;
            }
    
            /* Adjust font sizes, colors, etc., as needed */
            body {
                font-size: 12pt;
            }
        }
    </style>

    <script>
    function editDescription() {
        console.log("Editing description...");
        // Toggle visibility
        document.getElementById('descriptionText').style.display = 'none';
        document.getElementById('descriptionEdit').style.display = 'block';
        document.getElementById('editDescriptionBtn').style.display = 'none'; 
        document.getElementById('saveDescriptionBtn').style.display = 'block'; // Show save button
    }
    
    function saveDescription() {
        var editedText = document.getElementById('descriptionEdit').value;
        document.getElementById('descriptionText').textContent = editedText;
        // Toggle visibility back
        document.getElementById('descriptionEdit').style.display = 'none';
        document.getElementById('descriptionText').style.display = 'block';
        document.getElementById('saveDescriptionBtn').style.display = 'none'; // Hide save button
        document.getElementById('editDescriptionBtn').style.display = 'block'; 
        
        // AJAX request to send editedText to the server
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'job_view' job.id %}", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"); //跟服务器通讯，用的 url 编码，用的 form 形式，
                xhr.setRequestHeader("X-CSRFToken", "{{csrf_token }}");
        xhr.onreadystatechange = function() {
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                // Handle successful update here, e.g., show a success message
                console.log("Description updated successfully.");
            }
        };
        xhr.send("description=" + encodeURIComponent(editedText) + "&jobId={{job.id}}");
    }


    // for printing
    document.getElementById('descriptionEdit').style.display = 'none';
    document.getElementById('descriptionText').style.display = 'block';
    document.getElementById('saveDescriptionBtn').style.display = 'none'; // Hide save button
    document.getElementById('editDescriptionBtn').style.display = 'block'; 
        
    // AJAX request to send editedText to the server
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "{% url 'job_view' job.id %}", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.setRequestHeader("X-CSRFTOKEN", "{{ csrf_token }}");
    xhr.onreadystatechange = function() {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
            // Handle successful update here, e.g., show a success message
            console.log("Description updated successfully.");
        }
    };
    xhr.send("description=" + encodeURIComponent(editedText) + "&jobId={{job.id}}");

    </script>

</head>
<body>
    <div class="container">
        <h2>任务状态</h2>
        <div>
            <td>{{ job.id }}</td>
            <h4>当前任务状态: {{job.status}}</h4>
            <button onclick="printPage()">打印/保存为PDF</button>
            <script>
                function printPage() {
                    window.print();
                }
            </script>
        </div>
    <form method="post">
        {% csrf_token %}
            <table>
                <tr>
                    <th colspan="9"class="center-table-header">{{ job.id }}: 目前进度 </th>
                </tr>
            <!-- 刷新与返回 -->
            <div class="form-footer">
                <a href="{% url 'job_view' job.pk %}">刷新</a>
                <a href="{% url 'job_list' %}">返回</a>
            </div>

            <!-- 任务名称/内容描述/Sbatch_id -->
                <tr>
                    <th>任务名称</th>
                    <th>内容描述</th>               
                    <th>Sbatch_id</th>    
                </tr>

                <tr>
                    <td><div class="job">
                        <p>{{ job.name }}</p>
                    </div></td>
                    <td>
                        <div class="job">
                            <p id="descriptionText">{{ job.description }}</p>
                            <textarea id="descriptionEdit" style="display:none;">{{ job.description }}</textarea>
                            <button type="button" onclick="editDescription()" id="editDescriptionBtn">Edit</button>
                            <button type="button" onclick="saveDescription()" id="saveDescriptionBtn" style="display:none;">Save</button>
                        </div>
                    </td>
                    <td>{{ job.sbatch_job_id }}</td>

                </tr>
            </table>

            <table>
            <!-- 图片1-2 -->
            <tr>   
                <th>反应物生成物官能团随反应时间变化</th>
                <th>反应生成分子链分布情况</th>
            </tr>
            <tr>
                {% load static %}
                <!-- 图一 -->
                <td><img src="{% static img1_name %}" alt="图1" style="width: 100%;"></td> 
                <!-- 图二 -->
                <td><img src="{% static img2_name %}" alt="图2" style="width: 100%;"></td>                
            </tr>
            </table>

            <table>
            <!-- md 表格 -->
            <tr>   
                <th>md 表格</th>
            </tr>
            <tr>   
                <th>{{ markdown_content |safe}}</th>
            </tr>
            </table>

        </form>
        <footer>
            <p>© 2024 Job Management - 铁科翼辰计算平台</p>
        </footer>

        
</body>
</html>
